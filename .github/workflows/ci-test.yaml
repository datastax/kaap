name: CI - Build and tests
on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  build-and-unit-test:
    name: Build and test
    runs-on: ubuntu-20.04
    timeout-minutes: 60
    steps:
      - name: checkout
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: 17

      - name: Check license headers
        run: mvn license:check

      - name: Build
        run: mvn -B -T 1C -ntp -nsu install -DskipTests

      - name: Check CRDs and doc up-to-date
        run: |
          #!/bin/bash
          ./src/generate-crds-docs.sh
          if [[ `git status --porcelain` ]]; then
            echo "Found files changed after building, please run ./src/generate-crds-docs.sh and commit the changes"
            git status
            exit 1
          fi
      

      - name: Unit tests
        run: mvn -B -ntp -nsu test -pl '!tests'

  integration-tests:
    name: Integration tests - ${{ matrix.name }}
    runs-on: ubuntu-20.04
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Scaling
            group: scaling
          - name: Misc
            group: misc
          - name: Helm
            group: helm
    steps:
      - name: checkout
        uses: actions/checkout@v3

      - uses: azure/setup-helm@v3
        with:
          version: latest
          token: ${{ secrets.GITHUB_TOKEN }}
        if: ${{ matrix.group == 'helm' }}

      - name: Build Helm charts
        run: |
          set -e
          add_repos() {
            chart=$1
            cat $chart/Chart.yaml | grep "repository:" | grep -e "https://" -e "http://" | awk '{print $2}' | awk -F'/' '{print $NF} {print $0}' | xargs -n2 helm repo add
          }
          add_repos helm/pulsar-stack
          
          helm dependency build helm/pulsar-operator
          helm dependency build helm/pulsar-stack
        if: ${{ matrix.group == 'helm' }}

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: 17

      - name: Build
        run: mvn -B -T 1C -ntp -nsu clean install -DskipTests -pl tests -am -Dcheckstyle.skip -Dspotbugs.skip -Pskip-crds

      - name: Integration tests
        run: |
          #!/bin/bash
          mvn -B -ntp -nsu test -pl tests \
            -Dgroups='${{ matrix.group }}'
