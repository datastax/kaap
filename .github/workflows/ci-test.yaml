name: CI - Build and tests
on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  build-and-unit-test:
    name: Build and test
    runs-on: ubuntu-20.04
    timeout-minutes: 60
    steps:
      - name: checkout
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: 17

      - name: Build
        run: mvn -B -T 1C -ntp -nsu install -DskipTests

      - name: Check CRDs and doc up-to-date
        run: |
          #!/bin/bash
          ./src/generate-crds-docs.sh
          if [[ `git status --porcelain` ]]; then
            echo "Found files changed after building, please run ./src/generate-crds-docs.sh and commit the changes"
            git status
            exit 1
          fi
      

      - name: Unit tests
        run: mvn -B -ntp -nsu test -pl pulsar-operator

  integration-tests:
    name: Integration tests - ${{ matrix.name }}
    runs-on: ubuntu-20.04
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Scaling
            group: scaling
          - name: Misc
            group: misc
          - name: Helm
            group: helm
    steps:
      - name: checkout
        uses: actions/checkout@v3

      - uses: azure/setup-helm@v3
          with:
            version: latest
            token: ${{ secrets.GITHUB_TOKEN }}
        if: ${{ matrix.group == 'helm' }}

      - name: Build Helm charts
        run: |
          helm dependency build helm/pulsar-operator
          helm dependency build helm/pulsar-stack
        if: ${{ matrix.group == 'helm' }}

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: 17

      - name: Build
        run: mvn -B -T 1C -ntp -nsu install -DskipTests -pl pulsar-operator -am

      - name: Integration tests
        run: |
          #!/bin/bash
          echo "testcontainers.reuse.enable=true" > ~/.testcontainers.properties
          mvn -B -ntp -nsu test -pl tests \
            -Dpulsaroperator.tests.env.reuse=true \
            -Dgroups='${{ matrix.group }}'
          
