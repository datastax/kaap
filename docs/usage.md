# Usage
## Helm deployment (tested with K8s 1.25)

Install the stack operator and the CRDs with monitoring
```
export ns=mypulsar
helm repo add prom https://prometheus-community.github.io/helm-charts
helm dependency build helm/pulsar-stack
helm install -n $ns --create-namespace pulsar helm/pulsar-stack \
    --set pulsar-operatpr.operator.image=datastax/pulsaroperator:latest \
    --set kube-prometheus-stack.enabled=true \
    --set pulsarGrafanaDashboards.enabled=true \
    --set kube-prometheus-stack.grafana.adminPassword=grafana
```

Install a Pulsar cluster Custom Resource
```
kubectl -n $ns apply -f helm/examples/cluster.yaml

```

Wait for the cluster to be up and running
```
kubectl wait pulsar -n $ns pulsar-cluster --for condition=Ready=True --timeout=240s
```

Uninstall the cluster
```
kubectl -n $ns delete PulsarCluster pulsar-cluster
```

Uninstall the operator and the CRDs
```
helm delete pulsar -n $ns
```

### Setup token authentication

Enable authentication on the cluster. Secrets for super user roles are automatically generated by the operator.
```
global:
  auth:
    enabled: true
```

Generate a token for a subject, give them some permissions and produce a message using it.
```
PULSAR_TOKEN=$(kubectl exec deployment/pulsar-bastion -- bin/pulsar tokens create --private-key token-private-key/my-private.key --subject myuser)
echo $PULSAR_TOKEN
kubectl exec deployment/pulsar-bastion -- bin/pulsar-shell -e 'admin namespaces grant-permission --role myuser --actions produce,consume public/default'
kubectl exec deployment/pulsar-bastion -- bin/pulsar-shell -e "client --auth-params \"token:$PULSAR_TOKEN\" produce -m hello public/default/topic"
```

### Keycloak

See the [Keycloak example](../helm/examples/keycloak).